<?php include 'header.html.php'; ?>

<h1>Edit Event</h1>

<?php
	require 'DB.php';
	$dsn = 'mysql://pvaDBusr:V0ll3y@mysql.portlandvolleyball.org/pvaDB';
	$dbh = DB::connect($dsn);
	if (DB::isError($dbh)) {
		die($dbh->getMessage());
	}
	
	$id = $HTTP_POST_VARS['id'];
	
	if ($HTTP_POST_VARS['title'] != "") {
		$bOK = true;
		
		if ($HTTP_POST_VARS['date'] != "") {
			$dt_array = explode('/', $HTTP_POST_VARS['date']);
			if (!checkdate($dt_array[0], $dt_array[1], $dt_array[2])) {
				echo "<script language=\"Javascript\">";
				echo "alert(\"Date must be M(M)/D(D)/YYYY\");";
				echo "</script>";
			}
			$sql_dt = $dt_array[2] . '-' . $dt_array[0] . '-' . $dt_array[1];
		} else {$sql_dt = NULL;}
		if ($HTTP_POST_VARS['time'] != "") {$tm = $HTTP_POST_VARS['time'];}
		if ($HTTP_POST_VARS['description'] != "") {$desc = ereg_replace("'", "&#39", $HTTP_POST_VARS['description']);}
			else {$desc = "&nbsp";}
		if ($HTTP_POST_VARS['link'] != "") {$link = $HTTP_POST_VARS['link'];}
			else {$link = NULL;}
		$title = ereg_replace("'", "&#39", $HTTP_POST_VARS['title']);
		
		if ($bOK == true) {
			$sql_array = array($title, $desc, $sql_dt, $tm, $link, $id);
			$status = $dbh->query("UPDATE events SET title = ?, description = ?, dt = ?, tm = ?, link = ? WHERE id = ?", $sql_array);
			//$status = $dbh->execute($query);
			if (DB::isError($status)){
				die($status->getMessage());	
			} else {
				echo "This event has been successfully edited.";
			}
		}
	}
	
	$qry = $dbh->getAll("SELECT *
						FROM events
						WHERE id = $id");
	if (!$qry) { echo "<div style=\" width: 750px; font-weight: bold; text-align: center;\">Event deleted.</div>";}
	else {
		foreach ($qry as $result) {
			$dt_array = explode('-', $result[3]);
			$tm_array = explode(':', $result[4]);
			echo "<form name=\"editEvent\" class=\"eventForm\" method=\"post\">
				<table>
					<tr>
						<td>Date</td>
						<td><input type=\"text\" name=\"date\" value=\"";
						printf("%d/%d/%d\"></td>", $dt_array[1], $dt_array[2], $dt_array[0]);
						
			echo "
					</tr>
					<tr>
						<td>Time</td>
						<td><input type=\"text\" name=\"time\" value=\"";
						printf("%d:%02d", $tm_array[0], $tm_array[1]);
			echo "\"></td>
					</tr>
					<tr>
						<td>Event</td>
						<td><input type=\"text\" name=\"title\" value=\"$result[1]\"></td>
					</tr>
					<tr>
						<td>Comments</td>
						<td><textarea name=\"description\" cols=\"35\" rows=\"3\">$result[2]</textarea></td>
					</tr>
					<tr>
						<td>Link</td>
						<td><input type=\"text\" name=\"link\" value=\"$result[5]\"></td>
					<tr>
						<td>&nbsp;</td>
						<td><input type=\"submit\" value=\"Edit\"></td>
					</tr>
				</table>
				<input type=\"hidden\" name=\"id\" value=\"$result[0]\">
			</form>";
			echo "<form action=\"events_add.php\" method=\"post\" name=\"delete\" style=\"margin-left: 70px;\">";
			echo " <input type=\"hidden\" name=\"delete\" value=\"yes\">";
			echo " <input type=\"hidden\" name=\"id\" value=\"$id\">";
			echo "	<input type=\"submit\" value=\"Delete this event\" onclick=\"javascript:return confirm('Really delete this event?')\">";
			echo "</form>";
		}
	}
?>

</body>
</html>


